name: Windows

on:
  push:
    branches: [ main, 'v[0-9]+.x' ]
    paths-ignore: [ 'doc/**', '**.md' ]
  pull_request:
    paths-ignore: [ 'doc/**', '**.md' ]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - name: VS 2019 v142 C++17
            os: windows-2022
            generator: "Visual Studio 17 2022"
            cxx_standard: 17
            cmake_options: "-T v142"

          - name: VS 2019 v142 C++20
            os: windows-2022
            generator: "Visual Studio 17 2022"
            cxx_standard: 20
            cmake_options: "-T v142"

          - name: VS 2022 C++17 shared-lib
            os: windows-2022
            generator: "Visual Studio 17 2022"
            cxx_standard: 17
            cmake_options: "-DBUILD_SHARED_LIBS=ON"

          - name: VS 2022 C++20
            os: windows-2022
            generator: "Visual Studio 17 2022"
            cxx_standard: 20
            cmake_options: ""

          - name: VS 2022 C++23
            os: windows-2022
            generator: "Visual Studio 17 2022"
            cxx_standard: 23
            cmake_options: ""

          - name: VS 2022 Clang C++17 shared-lib
            os: windows-2022
            generator: "Visual Studio 17 2022"
            cxx_standard: 17
            cmake_options: "-T ClangCL -DBUILD_SHARED_LIBS=ON"

          - name: VS 2022 Clang C++20
            os: windows-2022
            generator: "Visual Studio 17 2022"
            cxx_standard: 20
            cmake_options: "-T ClangCL"

    steps:
    - uses: actions/checkout@v4
    - name: get dependencies
      run: init.bat
      shell: cmd
    - name: cmake
      run: cmake -S . -B build -G "${{ matrix.generator }}" -A x64 -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} ${{ matrix.cmake_options }}
    - name: build
      run: cmake --build build --config Release
    - name: test
      run: ctest --output-on-failure --test-dir build -C Release

  build_mingw:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - name: mingw g++ C++17
            os: windows-2025
            generator: Ninja
            cxx_standard: 17
            cmake_options: "-DCMAKE_CXX_COMPILER=g++ -DCMAKE_BUILD_TYPE=Release"

          - name: mingw g++ C++20 shared-lib
            os: windows-2025
            generator: Ninja
            cxx_standard: 20
            cmake_options: "-DCMAKE_CXX_COMPILER=g++ -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release"

    steps:
    - uses: actions/checkout@v4
    - name: get dependencies
      run: init.bat
      shell: cmd
    - name: cmake
      run: cmake -S . -B build -G "${{ matrix.generator }}" -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} ${{ matrix.cmake_options }}
    - name: build
      run: cmake --build build
    - name: test
      run: ctest --output-on-failure --test-dir build
